## Carebot Project - Image Provider

### ê°œìš”

Carebot ProjectëŠ” ë…ê±°ë…¸ì¸ì„ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ ìƒí™œ ë„ìš°ë¯¸ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ëŠ” ë‹¨ìˆœí•œ ëŒ€í™” ìƒëŒ€ë¥¼ ë„˜ì–´, ì¼ìƒ ì†ì—ì„œ ë™ë°˜ìê°€ ë˜ì–´ì£¼ê³ , ê¸´ê¸‰í•œ ìƒí™©ì—ì„œëŠ” ì‹ ì†í•œ ë„ì›€ì„ ì œê³µí•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

ë˜í•œ, Carebotì€ ê°€ì¡± ë° ìš”ì–‘ë³´í˜¸ì‚¬ê°€ ë…ê±°ë…¸ì¸ì˜ ìƒí™œ ìƒíƒœë¥¼ ì›ê²©ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•©ë‹ˆë‹¤. ëŒ€í™” ë‚´ì—­ì„ ë°”íƒ•ìœ¼ë¡œ ê°ì • ë° ì‹¬ë¦¬ ìƒíƒœë¥¼ ë¶„ì„í•˜ê³ , í™˜ê²½ ë° í™œë™ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ìœ„í—˜ ìš”ì†Œë¥¼ ê°ì§€í•¨ìœ¼ë¡œì¨ ë³´ë‹¤ ì•ˆì „í•œ ìƒí™œì„ ë•ìŠµë‹ˆë‹¤.

í™”ì¬ê°€ ë°œìƒí•˜ê±°ë‚˜ ë‚™ìƒì´ ë°œìƒí–ˆì„ ë•Œ, Carebotì—ì„œ ì´ë¯¸ì§€ë¥¼ ìº¡ì³í•´ì„œ ë³´í˜¸ìì—ê²Œ ì „ì†¡í•˜ì—¬ í˜„ì¬ ìƒíƒœë¥¼ ë³´ê³ í•˜ëŠ” ê¸°ëŠ¥ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë‹¨ìˆœíˆ ìƒí™© ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ê²ƒ ë³´ë‹¤, ì´ë¯¸ì§€ì™€ ì œê³µí•˜ê²Œ ë˜ë©´ì„œ í˜„ì¬ ìƒíƒœë¥¼ ì •í™•íˆ íŒŒì•…í•˜ê³  ì‹œìŠ¤í…œ ì˜¤ë¥˜ë¡œ ì˜ëª» íŒë‹¨ëœ ê²½ê³ ë¥¼ í•„í„°ë§ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ ì‚¬ìš©ì ê°„ì˜ ì´ë¯¸ì§€ë¥¼ ì£¼ê³  ë°›ìœ¼ë©´ì„œ ê°€ì¡± ê°„ì˜ ì•ˆë¶€ë¥¼ ë¬»ê³  ê¸°ë¶„ ì¢‹ì€ ìƒí™©ì„ ê³µìœ í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ê³ ì í•©ë‹ˆë‹¤. ê·¸ëŸ¬ê¸° ìœ„í•´ì„  **ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ì ‘ê·¼í•˜ë©°, ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ê°œë°œ**í•´ì•¼ í•©ë‹ˆë‹¤.

### ê¸°ìˆ 

| **ë¶„ì•¼** | **ì‚¬ìš©í•œ ê¸°ìˆ ** |
| --- | --- |
| Database | **MariaDB** 10.3.23 |
| Program Language | **Python** 3.11.9 |
| Server Architecture | **FastAPI** 0.115.6 |
| Cached Point | **Nginx** 1.18.0 |
| DB Library | **SQL-Alchemy** 2.0.37 |

### í”„ë¡œì íŠ¸ êµ¬ì¡°

![ìµœì¢…ì„œë¹„ìŠ¤](/uploads/c224e30672147ae64917ff9bf1bd0ab6/ìµœì¢…ì„œë¹„ìŠ¤.png)

ì´ RepositoryëŠ” Backend Server êµ¬ì¡° ì¤‘ì—ì„œ **Image Server** ë¶€ë¶„ì— í•´ë‹¹í•©ë‹ˆë‹¤.

### ì‹œìŠ¤í…œ êµ¬ì¡°

1. **`Database`**
    
    ì ‘ê·¼í•˜ëŠ” ë¡œê·¸ì¸ Session ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìœ íš¨í•œ ì ‘ê·¼ì¸ì§€ ê²€ì¦í•˜ê¸° ìœ„í•´ Databaseì˜ ì ‘ê·¼ì´ í•„ìˆ˜ì ì…ë‹ˆë‹¤. ì´ LibraryëŠ” Carebot Projectì˜ **Databaseë¥¼ ì ‘ê·¼í•˜ê¸° ìœ„í•œ ê¸°ëŠ¥ì´ í¬í•¨**ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    
    ìƒì„¸í•œ ë‚´ìš©ì€ Database Connector README.mdë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.
    
2. **`Utilites`**
    
    Databaseì— ì €ì¥ë˜ì–´ ìˆëŠ” ID ê°’ì„ ê°ì§€í•˜ê³ , Server Debuggingì„ ì›í™œí•˜ê²Œ í•˜ê¸° ìœ„í•´ì„œ Logë¥¼ ì¬ì •ì˜í•˜ëŠ” ê¸°ëŠ¥ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    
    ìƒì„¸í•œ ë‚´ìš©ì€ Utilities README.mdë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.
    
3. **`docker-compose.yml`**
    
    ë°°í¬ë¥¼ ìœ„í•´ì„œ í•„ìš”í•œ **Docker Containerì˜ ì„¤ì • ì •ë³´ê°€ í¬í•¨**ëœ Docker Compose ì •ë³´ì…ë‹ˆë‹¤.
    
4. **`Dockerfile`**
    
    ë°°í¬í•  ì´ë¯¸ì§€ì— ëŒ€í•œ **ê¸°ë³¸ ì´ë¯¸ì§€ì™€ íŒŒì¼ë“¤ì— ëŒ€í•œ ì •ì˜ê°€ í¬í•¨**ëœ Docker ì •ë³´ì…ë‹ˆë‹¤.
    
5. **`requirements.txt`**
    
    í•´ë‹¹ ì„œë¹„ìŠ¤ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ì„¤ì¹˜í•´ì•¼ í•˜ëŠ” Python Libraryì˜ ì¢…ë¥˜ì™€ ë²„ì „ì´ ê¸°ë¡ëœ ë¬¸ì„œì…ë‹ˆë‹¤.
    
    ì•„ë˜ëŠ” í•„ìˆ˜ì ìœ¼ë¡œ ì„¤ì¹˜í•´ì•¼ í•˜ëŠ” Libraryì˜ ëª©ë¡ê³¼ ê¸°ëŠ¥, ë²„ì „ì— ëŒ€í•œ ì„¤ëª…ì…ë‹ˆë‹¤.
    
    | Library | Description | Version |
    | --- | --- | --- |
    | **`fastapi`** | API & Web Framework | `0.115.6` |
    | **`uvicorn`** | ASGI web server | `0.34.0` |
    | **`PyMySQL`** | MySQL Library | `1.1.1` |
    | **`SQLAlchemy`** | SQL Toolkit and ORM | `2.0.37` |
    | **`python-detenv`** | Python Environment Library | `1.0.1` |
    | **`pydantic`** | Data Validation Library | `2.10.5` |
    | **`filetype`** | MIME Type Checking Library | `1.2.0` |
    | **`python-multipart`**  | Streaming Multipart Parser | `0.0.20` |
6. **`main.py`**
    
    Image Providerì— ëŒ€í•œ **ëª¨ë“  ê¸°ëŠ¥** (Verify, Upload, Provide, Delete)ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. 
    
    íŒŒì¼ì˜ í¬ê¸°ì™€ íŒŒì¼ ì¢…ë¥˜ì— ëŒ€í•œ ì œí•œ, Cache ê¸°ê°„ì— ëŒ€í•œ ì„¤ì •ì´ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    
    ```python
    checker_size: int = 2048
    allowed_types: list[str] = ["image/jpeg", "image/png", "image/gif", "image/webp"]
    max_image_size: int = int(os.getenv("MAX_IMAGE_SIZE")) * 1024 * 1024
    cache_duration: int = int(os.getenv("CACHE_DURATION"))
    ```
    
    ì œ3ìê°€ ë§í¬ë¥¼ ì™„ë²½íˆ ì•Œê³  ìˆë”ë¼ë„ ë¡œê·¸ì¸ ì—†ì´ëŠ” ì´ë¯¸ì§€ì— ëŒ€í•œ ì ‘ê·¼ì„ ë§‰ê¸° ìœ„í•´ Nginxê°€ ì „ë‹¬í•˜ì§€ ì•Šê³  **ì§ì ‘ FastAPI Frameworkì—ì„œ ì „ë‹¬í•˜ë„ë¡ ì„¤ê³„**í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ë§í¬ì— ì ‘ê·¼í•˜ê²Œ ë˜ë©´ ìš”ì²­ìì˜ Session ê°’ì„ ê²€ì¦í•˜ê³ , ê·¸ ìš”ì²­ìê°€ í•´ë‹¹ ì´ë¯¸ì§€ì— ì ‘ê·¼ ê°€ëŠ¥í•œ ì‚¬ìš©ìì¸ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •ì„ ê±°ì¹˜ê²Œ ë©ë‹ˆë‹¤.
    
    ```python
    # ì‚¬ìš©ì ê³„ì •ì„ í†µí•´ ì ‘ê·¼í•˜ëŠ”ì§€ í™•ì¸
    request_data: dict = Database.get_one_account(request_id)
    
    if not request_data:
        logger.warning(f"Can not access image: {request_id}")
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail={
                "type": "can not access",
                "message": "You do not have permission"
            }
        )
    
    # ì ‘ê·¼ ê¶Œí•œ ë²”ìœ„ ì„¤ì •
    accessible_id: list[str] = [request_id]
    
    if request_data["role"] == Role.MAIN:  # ì£¼ ì‚¬ìš©ìê°€ ì ‘ê·¼í•œ ê²½ìš° ì†Œì†ëœ ê°€ì¡± ì´ë¯¸ì§€ê¹Œì§€ ì ‘ê·¼ ê°€ëŠ¥
        family_id: str = Database.main_id_to_family_id(request_id)
        member_data: list[dict] = Database.get_all_members(family_id=family_id)
        for member in member_data:
           accessible_id.append(member["user_id"])
    elif request_data["role"] == Role.SUB:  # ë³´ì¡° ì‚¬ìš©ìê°€ ì ‘ê·¼í•œ ê²½ìš° ì†Œì†ëœ ì£¼ ì‚¬ìš©ìë“¤ì˜ ì´ë¯¸ì§€ê¹Œì§€ ì ‘ê·¼ ê°€ëŠ¥
        member_data: list[dict] = Database.get_all_members(user_id=request_id)
        family_id_list: list[str] = [member["family_id"] for member in member_data]
        for family_id in family_id_list:
            family_data: dict = Database.get_one_family(family_id)
            accessible_id.append(family_data["main_user"])
    
    # ìš”ì²­í•œ ì‚¬ìš©ìê°€ í•´ë‹¹ ì´ë¯¸ì§€ ê²½ë¡œì— ì ‘ê·¼ ê°€ëŠ¥í•œì§€ ì ê²€
    if request_data["role"] != Role.SYSTEM and user_id not in accessible_id:
        logger.warning(f"Can not access image: {request_id}")
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail={
                "type": "can not access",
                "message": "You do not have permission"
            }
        )
    ```
    
    í•´ë‹¹ ì„œë¹„ìŠ¤ëŠ” ì´ë¯¸ì§€ë¥¼ ê´€ë¦¬í•˜ëŠ” ì„œë²„ì´ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ ì¢…ë¥˜ì˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ëŠ” ì˜ˆì™¸ ìƒí™©ì„ ë°©ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ íŒŒì¼ ë§¨ ì•ì˜ Binaryë¥¼ ì½ì–´ì„œ ì‹¤ì œ íŒŒì¼ì˜ í˜•ì‹ì„ ì½ì–´ ì¢…ë¥˜ë¥¼ íŒŒì•…í•˜ë„ë¡ ì„¤ê³„í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ **í™•ì¥ì ì´ë¦„ì„ ë³€ì¡°í•œ ê²½ìš°ì—ë„ íŒŒì¼ í˜•ì‹ì„ ì •í™•íˆ íŒŒì•…**í•˜ì—¬ ì˜ë„ì— ë²—ì–´ë‚œ íŒŒì¼ì´ Serverì— ì—…ë¡œë“œ ë˜ëŠ” ê²½ìš°ë¥¼ ìµœëŒ€í•œ ë°©ì§€í•©ë‹ˆë‹¤.
    
    ```python
    # íŒŒì¼ ë‚´ìš© ê²€ì‚¬
        file_bytes = await file.read(checker_size)
        file_type = filetype.guess(file_bytes)
    
        if file_type is None or file_type.mime not in allowed_types:
            logger.warning(f"Invalid file type: {file_type.mime if file_type else 'unknown'}")
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail={
                    "type": "invalid value",
                    "message": "Only image files can be uploaded",
                    "input":{
                        "request_id": request_id,
                        "file_name": file.filename,
                        "file_type": file_type.mime if file_type else 'unknown'
                    }
                }
            )
    ```
    

### ê¸°ëŠ¥ ì •ì˜

1. **Image Upload**
    > ğŸ” **[ì ‘ê·¼ ê¶Œí•œì´ ì¡´ì¬í•©ë‹ˆë‹¤]** \
    ì‚¬ìš©ì ê³„ì •ì´ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.

    > ğŸŒ **POST `https://image.itdice.net/upload`**
    
    - Parameter

        | - | - | - |
        | --- | --- | --- |
    - Body - formdata
        
        | **`file`** | ì´ë¯¸ì§€ ë°ì´í„° **[í•„ìˆ˜]** | `File` |
        | --- | --- | --- |
        
2. **Image Access**
    > ğŸ” **[ì ‘ê·¼ ê¶Œí•œì´ ì¡´ì¬í•©ë‹ˆë‹¤]** \
    ë¡œê·¸ì¸ ëœ ì‚¬ìš©ìê°€ í•´ë‹¹ ì´ë¯¸ì§€ ì†Œìœ ìì™€ **ê°™ì€ Family** ì´ì–´ì•¼ í•©ë‹ˆë‹¤. \
    *ê´€ë¦¬ì(System)ì„ ì œì™¸í•œ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì ìš©ë¨*

    > ğŸŒ **GET `https://image.itdice.net/access/:user-id/:file-name`**
    
    - Parameter

        | **`user-id`** | ì´ë¯¸ì§€ì˜ ì†Œìœ ì ID **[í•„ìˆ˜]** | `String` |
        | --- | --- | --- |
        | **`file-name`** | ì´ë¯¸ì§€ì˜ íŒŒì¼ëª… **[í•„ìˆ˜]** | `String` |
    - Body - formdata

        |  |  |  |
        | --- | --- | --- |
        
3. **Image Delete**
    > ğŸ” **[ì ‘ê·¼ ê¶Œí•œì´ ì¡´ì¬í•©ë‹ˆë‹¤]** \
    ë¡œê·¸ì¸ ëœ **ì‚¬ìš©ìì˜ ID**ì™€ **ì´ë¯¸ì§€ì˜ ì†Œìœ ì**ê°€ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤. \
    *ê´€ë¦¬ì(System)ì„ ì œì™¸í•œ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì ìš©ë¨*

    > ğŸŒ **DELETE `https://image.itdice.net/delete/:user-id/:file-name`**
    
    - Parameter

        | **`user-id`** | ì´ë¯¸ì§€ì˜ ì†Œìœ ì ID **[í•„ìˆ˜]** | `String` |
        | --- | --- | --- |
        | **`file-name`** | ì´ë¯¸ì§€ì˜ íŒŒì¼ëª… **[í•„ìˆ˜]** | `String` |
    - Body - formdata

        |  |  |  |
        | --- | --- | --- |